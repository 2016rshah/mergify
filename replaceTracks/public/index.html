<!doctype html>
<html>
  <head>
    <title>Example of the Implicit Grant flow with Spotify</title>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">    
    <style type="text/css">
      #login, #loggedin {
        display: none;
      }
      .text-overflow {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 500px;
      }
    </style>
    <script src = "spotify-web-api.js"></script>
  </head>

  <body>
    <div class="container">
      <div id="login">
        <h1>This is an example of the Implicit Grant flow</h1>
        <button id="login-button" class="btn btn-primary">Log in with Spotify</button>
      </div>
      <div id="loggedin">
        <div id="user-profile">
        </div>
        <div id="oauth">
        </div>
      </div>
    </div>

    <script id="user-profile-template" type="text/x-handlebars-template">
      
      <h1>Logged in as {{display_name}}</h1>



      <div class="media">
        <div class="pull-left">
          <img class="media-object" width="150" src="{{images.0.url}}" />
        </div>
        <div class="media-body">
          <!--<dl class="dl-horizontal">
            <dt>Display name</dt><dd class="clearfix">{{display_name}}</dd>
            <dt>Id</dt><dd>{{id}}</dd>
            <dt>Email</dt><dd>{{email}}</dd>
            <dt>Spotify URI</dt><dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
            <dt>Link</dt><dd><a href="{{href}}">{{href}}</a></dd>
            <dt>Profile Image</dt><dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>
            <dt>Country</dt><dd>{{country}}</dd>
          </dl>-->
          <dl class = "dl-horizontal">
            <div id = "playlistForm">
              <form>
              <dt>Playlist 1: </dt><dd><input id = "playlist1" type="text" name="First Playlist"></dd>
              <dt>Playlist 2: </dt><dd><input id = "playlist2" type="text" name="Second Playlist"></dd>
              </form>
              <br>
              <dd><button id = "findPlaylist" class = "btn btn-default btn-lg">Find 2 playlists</button></dd>
            </div>
          </dl>
        </div>
      </div>
    </script>

    <script id="oauth-template" type="text/x-handlebars-template">
      <h2>oAuth info</h2>
      <dl class="dl-horizontal">
        <dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
      </dl>
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script>
      access_token = "";
      (function() {

        var stateKey = 'spotify_auth_state';

        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
             hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }

        /**
         * Generates a random string containing numbers and letters
         * @param  {number} length The length of the string
         * @return {string} The generated string
         */
        function generateRandomString(length) {
          var text = '';
          var possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';

          for (var i = 0; i < length; i++) {
            text += possible.charAt(Math.floor(Math.random() * possible.length));
          }
          return text;
        };

        var userProfileSource = document.getElementById('user-profile-template').innerHTML,
            userProfileTemplate = Handlebars.compile(userProfileSource),
            userProfilePlaceholder = document.getElementById('user-profile');

            oauthSource = document.getElementById('oauth-template').innerHTML,
            oauthTemplate = Handlebars.compile(oauthSource),
            oauthPlaceholder = document.getElementById('oauth');

        var params = getHashParams();

        access_token = params.access_token;
        var state = params.state,
            storedState = localStorage.getItem(stateKey);

        if (access_token && (state == null || state !== storedState)) {
          alert('There was an error during the authentication');
        } else {
          localStorage.removeItem(stateKey);
          if (access_token) {
            $.ajax({
                url: 'https://api.spotify.com/v1/me',
                headers: {
                  'Authorization': 'Bearer ' + access_token
                },
                success: function(response) {
                  userProfilePlaceholder.innerHTML = userProfileTemplate(response);

                  $('#login').hide();
                  $('#loggedin').show();
                }
            });
          } else {
              $('#login').show();
              $('#loggedin').hide();
          }

          document.getElementById('login-button').addEventListener('click', function() {

            var client_id = 'c5420045770248e9846f1c2c20721cea'; // Your client id
            var redirect_uri = 'http://localhost:8888/'; // Your redirect uri

            var state = generateRandomString(16);

            localStorage.setItem(stateKey, state);
             //var scope = 'playlist-read-private user-read-private user-read-email';
            var scope = 'playlist-read-private playlist-modify-public playlist-modify-private user-read-private user-read-email';

            var url = 'https://accounts.spotify.com/authorize';
            url += '?response_type=token';
            url += '&client_id=' + encodeURIComponent(client_id);
            url += '&scope=' + encodeURIComponent(scope);
            url += '&redirect_uri=' + encodeURIComponent(redirect_uri);
            url += '&state=' + encodeURIComponent(state);

            window.location = url;
            // onAuthorize();
          }, false);
        }
      })();
        // function onAuthorize(){
            spotifyApi = new SpotifyWebApi();
            spotifyApi.setAccessToken(access_token);
            me = "this shouldn't still be here";
            spotifyApi.getMe(function(err, data){
              if(err){console.log(err);}
              else{
                  me = data;
                  getPlaylistsOnLoad(spotifyApi, me);
                  //createPlaylistOnLoad(spotifyApi, me);
              }
            });
        // }

        function getPlaylistsOnLoad(spotifyApi, me){
          document.getElementById("findPlaylist").onclick = function(){
            spotifyApi.getUserPlaylists(me.id, function(err, data){
                if(err){console.log(err);}
                else{
                  playlists = data.items;
                  playlist1 = playlists.filter(function(e){
                    //this happens way too early for there to be text in playlist1
                    return e.name == $("#playlist1").val();
                  });
                  playlist1 = playlist1[0];
                  console.log(playlist1);
                  playlist2 = playlists.filter(function(e){
                    //this happens way too early for there to be text in playlist1
                    return e.name == $("#playlist2").val();
                  });
                  playlist2 = playlist2[0];
                  console.log(playlist2);
                  if(playlist1!==undefined && playlist2!==undefined){
                    mergeTracks(spotifyApi, me, playlist1, playlist2);
                  }
                }
            });
          }
        }
        function createPlaylistOnLoad(spotifyApi, me){
          playlistJSON = {
            "name":"Test2",
            "public":true
          };
          spotifyApi.createPlaylist(me.id, playlistJSON, function(err, data){
                    if(err)
                        console.log(err);
                    else{
                        console.log(data)
                    }
                  });
        }
        function mergeTracks(spotifyApi, me, playlist1, playlist2){
          console.log("tracks!");
          spotifyApi.getPlaylistTracks(me.id, playlist1.id, function(err, data){
            if(err){console.log(err);}
            else{
              tracks1 = data.items;
              console.log(tracks1);
              spotifyApi.getPlaylistTracks(me.id, playlist2.id, function(err, data){
                if(err){console.log(err);}
                else{
                  tracks2 = data.items;
                  console.log(tracks2);
                  var toAdd = []
                  for(var i = 0; i<tracks1.length; i++){
                    toAdd.push(tracks1[i].track.uri);
                  }
                  for(var i = 0; i<tracks2.length; i++){
                    toAdd.push(tracks2[i].track.uri);
                  }
                  console.log(toAdd);
                  var tracksJSON = {
                    uris : toAdd,
                    position:0
                  }
                  console.log(tracksJSON);
                  spotifyApi.addTracksToPlaylist(me.id, "5whmdmTsQ7Df1BcAh7ZaeI", toAdd, function(err, data){
                    if(err){console.log(err);}
                    else{
                      console.log(data);
                      console.log("added tracks!");
                    }
                  })
                }
              });
            }
          });
          
        }
    </script>
</html>
